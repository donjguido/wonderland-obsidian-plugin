name: Tests

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest]
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: matrix.os == 'ubuntu-latest' && matrix.node-version == '20.x'
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest]
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build plugin
        run: npm run build

      - name: Verify build artifacts
        run: |
          test -f main.js && echo "✓ main.js exists" || (echo "✗ main.js missing" && exit 1)
          test -f manifest.json && echo "✓ manifest.json exists" || (echo "✗ manifest.json missing" && exit 1)
          test -f styles.css && echo "✓ styles.css exists" || (echo "✗ styles.css missing" && exit 1)

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: matrix.os == 'ubuntu-latest' && matrix.node-version == '20.x'
        with:
          name: plugin-build
          path: |
            main.js
            manifest.json
            styles.css
          retention-days: 7

  type-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit --skipLibCheck

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for common issues
        run: |
          # Check for console.log statements (excluding debug functions)
          echo "Checking for exposed console.log statements..."
          ! grep -rn "console\.log" src/ --include="*.ts" | grep -v "debugLog" | grep -v "//.*console" || echo "Warning: Found console.log statements"

          # Check for innerHTML usage (security concern)
          echo "Checking for innerHTML usage..."
          ! grep -rn "innerHTML" src/ --include="*.ts" || echo "Warning: Found innerHTML usage - consider using DOM API"

          echo "Lint checks completed"
